name: Create installers

on:
  push:
    branches:
      - main
  workflow_dispatch:
  
jobs:
  set-version-number:
    name: Set version number
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup .NET 7
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

  build-winget:
    name: Winget - Update package manifest in the OWC
    needs:
     - set-version-number
    runs-on: windows-latest
    #if: ${{ needs.set-version-number.outputs.is-release == 'true' }}

    steps:
    - name: Winget-Create
      run: |

        $version = "$($env:version)"

        # Download wingetcreate
        iwr https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

        $x64Url="https://github.com/erikbra/grate/releases/download/$version/grate-msi-win-x64-$version.msi"
        $arm64Url="https://github.com/erikbra/grate/releases/download/$version/grate-msi-win-arm64-$version.msi"

        echo "Running ./wingetcreate.exe update erikbra.grate --urls $x64Url $arm64Url -v $version -t `"$env:WINGET_GH_PAT`" "#--submit"
        #./wingetcreate.exe update erikbra.grate --urls $x64Url $arm64Url -v $version -t "$env:WINGET_GH_PAT" #--submit
        ./wingetcreate.exe new $x64Url $arm64Url
      env:
        WINGET_GH_PAT: ${{ secrets.WINGET_GH_PAT }}
        version: "1.5.2"
        #version: "${{ needs.set-version-number.outputs.nuGetVersion }}"

